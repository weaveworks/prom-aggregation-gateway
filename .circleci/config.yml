version: 2.1

jobs:
  test:
    docker:
    - image: circleci/golang:1.12
    working_directory: /go/src/github.com/moia-dev/dynamic-routing-saturn
    steps:
    - checkout
    - run: make test
    - run: make lint
    - run: make codecov

  push:
    docker:
    - image: circleci/python:3
    steps:
    - checkout
    - setup_remote_docker
    - run: sudo pip install awscli
    - run: |
        source <(echo "export $PRD_CI_AWS_CREDENTIALS")
        make push-image

workflows:
  version: 2
  production-pipeline:
    jobs:
    - test:
        filters:
          branches:
            only: master
    - push:
        requires:
        - test
